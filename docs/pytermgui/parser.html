<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 10.0.3"/>
    <title>pytermgui.parser API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc section{margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:2.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pytermgui.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pytermgui</a>

            <img src="https://github.com/bczsalba/pytermgui/blob/master/assets/title.png?raw=true" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

        <h2>Contents</h2>
        <ul>
  <li><a href="#basic-rundown">Basic rundown</a></li>
  <li><a href="#general-syntax">General syntax</a></li>
  <li><a href="#markuplanguage-and-instancing"><code>MarkupLanguage</code> and instancing</a></li>
  <li><a href="#caching">Caching</a></li>
  <li><a href="#customization">Customization</a></li>
</ul>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="variable" href="#MacroCallable">MacroCallable</a>
            </li>
            <li>
                    <a class="variable" href="#MacroCall">MacroCall</a>
            </li>
            <li>
                    <a class="class" href="#MarkupLanguage">MarkupLanguage</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MarkupLanguage.__init__">MarkupLanguage</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkupLanguage.raise_unknown_markup">raise_unknown_markup</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.print">print</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.tokenize_markup">tokenize_markup</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.tokenize_ansi">tokenize_ansi</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.define">define</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.alias">alias</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.parse">parse</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.get_markup">get_markup</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.prettify_ansi">prettify_ansi</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkupLanguage.prettify_markup">prettify_markup</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StyledText">StyledText</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StyledText.__init__">StyledText</a>
                        </li>
                        <li>
                                <a class="variable" href="#StyledText.value">value</a>
                        </li>
                        <li>
                                <a class="variable" href="#StyledText.plain">plain</a>
                        </li>
                        <li>
                                <a class="variable" href="#StyledText.tokens">tokens</a>
                        </li>
                        <li>
                                <a class="function" href="#StyledText.plain_index">plain_index</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#markup">markup</a>
            </li>
            <li>
                    <a class="variable" href="#tim">tim</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../pytermgui.html">pytermgui</a><wbr>.parser    </h1>

                        <div class="docstring"><p>This module provides <code>TIM</code>, PyTermGUI's Terminal Inline Markup language. It is a simple,
performant and easy to read way to style, colorize &amp; modify text.</p>

<h2 id="basic-rundown">Basic rundown</h2>

<p>TIM is included with the purpose of making styling easier to read and manage.</p>

<p>Its syntax is based on square brackets, within which tags are strictly separated by one
space character. Tags can stand for colors (xterm-256, RGB or HEX, both background &amp;
foreground), styles, unsetters and macros.</p>

<p>The 16 simple colors of the terminal exist as named tags that refer to their numerical
value.</p>

<p>Here is a simple example of the syntax, using the <code><a href="pretty.html">pytermgui.pretty</a></code> submodule to
syntax-highlight it inside the REPL:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pytermgui</span> <span class="kn">import</span> <span class="n">pretty</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;[141 @61 bold] Hello [!upper inverse] There &#39;</span>
</code></pre></div>

<p align=center>
<img src="https://github.com/bczsalba/pytermgui/blob/master/assets/docs/parser/simple_example.png?raw=true" width=70%>
</p>

<h2 id="general-syntax">General syntax</h2>

<p>Background colors are always denoted by a leading <code>@</code> character in front of the color
tag. Styles are just the name of the style and macros have an exclamation mark in front
of them. Additionally, unsetters use a leading slash (<code>/</code>) for their syntax. Color
tokens have special unsetters: they use <code>/fg</code> to cancel foreground colors, and <code>/bg</code> to
do so with backgrounds.</p>

<h3 id="macros">Macros:</h3>

<p>Macros are any type of callable that take at least *args; this is the value of the plain
text enclosed by the tag group within which the given macro resides. Additionally,
macros can be given any number of positional arguments from within markup, using the
syntax:</p>

<pre><code>[!macro(arg1:arg2:arg3)]Text that the macro applies to.[/!macro]plain text, no macro
</code></pre>

<p>This syntax gets parsed as follows:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="n">macro</span><span class="p">(</span><span class="s2">&quot;Text that the macro applies to.&quot;</span><span class="p">,</span> <span class="s2">&quot;arg1&quot;</span><span class="p">,</span> <span class="s2">&quot;arg2&quot;</span><span class="p">,</span> <span class="s2">&quot;arg3&quot;</span><span class="p">)</span>
</code></pre></div>

<p><code>macro</code> here is whatever the name <code>macro</code> was defined as prior.</p>

<h3 id="colors">Colors:</h3>

<p>Colors can be of three general types: xterm-256, RGB and HEX.</p>

<p><code>xterm-256</code> stands for one of the 256 xterm colors. You can use <code>ptg -c</code> to see the all
of the available colors. Its syntax is just the 0-base index of the color, like <code>[141]</code></p>

<p><code>RGB</code> colors are pretty self explanatory. Their syntax is follows the format
<code>RED;GREEN;BLUE</code>, such as <code>[111;222;333]</code>.</p>

<p><code>HEX</code> colors are basically just RGB with extra steps. Their syntax is <code>#RRGGBB</code>, such as
<code>[#FA72BF]</code>. This code then gets converted to a tuple of RGB colors under the hood, so
from then on RGB and HEX colors are treated the same, and emit the same tokens.</p>

<p>As mentioned above, all colors can be made to act on the background instead by
prepending the color tag with <code>@</code>, such as <code>@141</code>, <code>@111;222;333</code> or <code>@#FA72BF</code>. To
clear these effects, use <code>/fg</code> for foreground and <code>/bg</code> for background colors.</p>

<h2 id="markuplanguage-and-instancing"><code><a href="#MarkupLanguage">MarkupLanguage</a></code> and instancing</h2>

<p>All markup behaviour is done by an instance of the <code><a href="#MarkupLanguage">MarkupLanguage</a></code> class. This is done
partially for organization reasons, but also to allow a sort of sandboxing of custom
definitions and settings.</p>

<p>PyTermGUI provides the <code><a href="#tim">tim</a></code> name as the global markup language instance. For historical
reasons, the same instance is available as <code><a href="#markup">markup</a></code>. This should be used pretty much all
of the time, and custom instances should only ever come about when some
security-sensitive macro definitions are needed, as <code><a href="#markup">markup</a></code> is used by every widget,
including user-input ones such as <code>InputField</code>.</p>

<p>For the rest of this page, <code><a href="#MarkupLanguage">MarkupLanguage</a></code> will refer to whichever instance you are
using.</p>

<p>TL;DR : Use <code><a href="#tim">tim</a></code> always, unless a security concern blocks you from doing so.</p>

<h2 id="caching">Caching</h2>

<p>By default, all markup parse results are cached and returned when the same input is
given. To disable this behaviour, set your markup instance (usually <code><a href="#markup">markup</a></code>)'s
<code>should_cache</code> field to False.</p>

<h2 id="customization">Customization</h2>

<p>There are a couple of ways to customize how markup is parsed. Custom tags can be created
by calling <code><a href="#MarkupLanguage.alias">MarkupLanguage.alias</a></code>. For defining custom macros, you can use
<code><a href="#MarkupLanguage.define">MarkupLanguage.define</a></code>. For more information, see each method's documentation.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides `TIM`, PyTermGUI&#39;s Terminal Inline Markup language. It is a simple,</span>
<span class="sd">performant and easy to read way to style, colorize &amp; modify text.</span>

<span class="sd">Basic rundown</span>
<span class="sd">-------------</span>

<span class="sd">TIM is included with the purpose of making styling easier to read and manage.</span>

<span class="sd">Its syntax is based on square brackets, within which tags are strictly separated by one</span>
<span class="sd">space character. Tags can stand for colors (xterm-256, RGB or HEX, both background &amp;</span>
<span class="sd">foreground), styles, unsetters and macros.</span>

<span class="sd">The 16 simple colors of the terminal exist as named tags that refer to their numerical</span>
<span class="sd">value.</span>

<span class="sd">Here is a simple example of the syntax, using the `pytermgui.pretty` submodule to</span>
<span class="sd">syntax-highlight it inside the REPL:</span>

<span class="sd">```python3</span>
<span class="sd">&gt;&gt;&gt; from pytermgui import pretty</span>
<span class="sd">&gt;&gt;&gt; &#39;[141 @61 bold] Hello [!upper inverse] There &#39;</span>
<span class="sd">```</span>

<span class="sd">&lt;p align=center&gt;</span>
<span class="sd">&lt;img src=&quot;https://github.com/bczsalba/pytermgui/blob/master/assets/docs/parser/\</span>
<span class="sd">simple_example.png?raw=true&quot; width=70%&gt;</span>
<span class="sd">&lt;/p&gt;</span>


<span class="sd">General syntax</span>
<span class="sd">--------------</span>

<span class="sd">Background colors are always denoted by a leading `@` character in front of the color</span>
<span class="sd">tag. Styles are just the name of the style and macros have an exclamation mark in front</span>
<span class="sd">of them. Additionally, unsetters use a leading slash (`/`) for their syntax. Color</span>
<span class="sd">tokens have special unsetters: they use `/fg` to cancel foreground colors, and `/bg` to</span>
<span class="sd">do so with backgrounds.</span>

<span class="sd">### Macros:</span>

<span class="sd">Macros are any type of callable that take at least *args; this is the value of the plain</span>
<span class="sd">text enclosed by the tag group within which the given macro resides. Additionally,</span>
<span class="sd">macros can be given any number of positional arguments from within markup, using the</span>
<span class="sd">syntax:</span>

<span class="sd">```</span>
<span class="sd">[!macro(arg1:arg2:arg3)]Text that the macro applies to.[/!macro]plain text, no macro</span>
<span class="sd">```</span>

<span class="sd">This syntax gets parsed as follows:</span>

<span class="sd">```python3</span>
<span class="sd">macro(&quot;Text that the macro applies to.&quot;, &quot;arg1&quot;, &quot;arg2&quot;, &quot;arg3&quot;)</span>
<span class="sd">```</span>

<span class="sd">`macro` here is whatever the name `macro` was defined as prior.</span>

<span class="sd">### Colors:</span>

<span class="sd">Colors can be of three general types: xterm-256, RGB and HEX.</span>

<span class="sd">`xterm-256` stands for one of the 256 xterm colors. You can use `ptg -c` to see the all</span>
<span class="sd">of the available colors. Its syntax is just the 0-base index of the color, like `[141]`</span>

<span class="sd">`RGB` colors are pretty self explanatory. Their syntax is follows the format</span>
<span class="sd">`RED;GREEN;BLUE`, such as `[111;222;333]`.</span>

<span class="sd">`HEX` colors are basically just RGB with extra steps. Their syntax is `#RRGGBB`, such as</span>
<span class="sd">`[#FA72BF]`. This code then gets converted to a tuple of RGB colors under the hood, so</span>
<span class="sd">from then on RGB and HEX colors are treated the same, and emit the same tokens.</span>

<span class="sd">As mentioned above, all colors can be made to act on the background instead by</span>
<span class="sd">prepending the color tag with `@`, such as `@141`, `@111;222;333` or `@#FA72BF`. To</span>
<span class="sd">clear these effects, use `/fg` for foreground and `/bg` for background colors.</span>

<span class="sd">`MarkupLanguage` and instancing</span>
<span class="sd">-------------------------------</span>

<span class="sd">All markup behaviour is done by an instance of the `MarkupLanguage` class. This is done</span>
<span class="sd">partially for organization reasons, but also to allow a sort of sandboxing of custom</span>
<span class="sd">definitions and settings.</span>

<span class="sd">PyTermGUI provides the `tim` name as the global markup language instance. For historical</span>
<span class="sd">reasons, the same instance is available as `markup`. This should be used pretty much all</span>
<span class="sd">of the time, and custom instances should only ever come about when some</span>
<span class="sd">security-sensitive macro definitions are needed, as `markup` is used by every widget,</span>
<span class="sd">including user-input ones such as `InputField`.</span>

<span class="sd">For the rest of this page, `MarkupLanguage` will refer to whichever instance you are</span>
<span class="sd">using.</span>

<span class="sd">TL;DR : Use `tim` always, unless a security concern blocks you from doing so.</span>

<span class="sd">Caching</span>
<span class="sd">-------</span>

<span class="sd">By default, all markup parse results are cached and returned when the same input is</span>
<span class="sd">given. To disable this behaviour, set your markup instance (usually `markup`)&#39;s</span>
<span class="sd">`should_cache` field to False.</span>

<span class="sd">Customization</span>
<span class="sd">-------------</span>

<span class="sd">There are a couple of ways to customize how markup is parsed. Custom tags can be created</span>
<span class="sd">by calling `MarkupLanguage.alias`. For defining custom macros, you can use</span>
<span class="sd">`MarkupLanguage.define`. For more information, see each method&#39;s documentation.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=too-many-lines</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span> <span class="k">as</span> <span class="n">_auto</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">.ansi_interface</span> <span class="kn">import</span> <span class="n">foreground</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">MarkupSyntaxError</span><span class="p">,</span> <span class="n">AnsiSyntaxError</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;MacroCallable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MacroCall&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MarkupLanguage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;StyledText&quot;</span><span class="p">,</span>
    <span class="s2">&quot;markup&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tim&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">MacroCallable</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="n">MacroCall</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">MacroCallable</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>

<span class="n">RE_ANSI</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:\x1b\[(.*?)m)|(?:\x1b\](.*?)\x1b</span><span class="se">\\</span><span class="s2">)|(?:\x1b_G(.*?)\x1b</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">RE_MACRO</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(![a-z0-9_]+)(?:\(([\w\/\.?\-=:]+)\))?&quot;</span><span class="p">)</span>
<span class="n">RE_MARKUP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((</span><span class="se">\\</span><span class="s2">*)\[([a-z0-9!#@_\/\(,\)].*?)\])&quot;</span><span class="p">)</span>

<span class="n">RE_256</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([\d]{1,3})$&quot;</span><span class="p">)</span>
<span class="n">RE_HEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#([0-9a-fA-F]</span><span class="si">{6}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">RE_RGB</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d{1,3};\d{1,3};\d{1,3})&quot;</span><span class="p">)</span>

<span class="n">STYLE_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;bold&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;italic&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;underline&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;blink&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;blink2&quot;</span><span class="p">:</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inverse&quot;</span><span class="p">:</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span>
    <span class="s2">&quot;invisible&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;strikethrough&quot;</span><span class="p">:</span> <span class="s2">&quot;9&quot;</span><span class="p">,</span>
    <span class="s2">&quot;overline&quot;</span><span class="p">:</span> <span class="s2">&quot;53&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">UNSETTER_MAP</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/bold&quot;</span><span class="p">:</span> <span class="s2">&quot;22&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/dim&quot;</span><span class="p">:</span> <span class="s2">&quot;22&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/italic&quot;</span><span class="p">:</span> <span class="s2">&quot;23&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/underline&quot;</span><span class="p">:</span> <span class="s2">&quot;24&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/blink&quot;</span><span class="p">:</span> <span class="s2">&quot;25&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/blink2&quot;</span><span class="p">:</span> <span class="s2">&quot;26&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/inverse&quot;</span><span class="p">:</span> <span class="s2">&quot;27&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/invisible&quot;</span><span class="p">:</span> <span class="s2">&quot;28&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/strikethrough&quot;</span><span class="p">:</span> <span class="s2">&quot;29&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/fg&quot;</span><span class="p">:</span> <span class="s2">&quot;39&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/bg&quot;</span><span class="p">:</span> <span class="s2">&quot;49&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/overline&quot;</span><span class="p">:</span> <span class="s2">&quot;54&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">macro_align</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alignment</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Aligns given text using fstrings.</span>

<span class="sd">    Args:</span>
<span class="sd">        width: The width to align to.</span>
<span class="sd">        alignment: One of &quot;left&quot;, &quot;center&quot;, &quot;right&quot;.</span>
<span class="sd">        content: The content to align; implicit argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">aligner</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span> <span class="k">if</span> <span class="n">alignment</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">alignment</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span> <span class="k">else</span> <span class="s2">&quot;^&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content</span><span class="si">:{</span><span class="n">aligner</span><span class="si">}{</span><span class="n">width</span><span class="si">}}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">macro_expand</span><span class="p">(</span><span class="n">lang</span><span class="p">:</span> <span class="n">MarkupLanguage</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Expands a tag alias.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">lang</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tag</span>

    <span class="k">return</span> <span class="n">lang</span><span class="o">.</span><span class="n">get_markup</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">lang</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;m &quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">macro_strip_fg</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Strips foreground color from item&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;[/fg]&quot;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">macro_strip_bg</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Strips foreground color from item&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;[/bg]&quot;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">macro_shuffle</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Shuffles a string using shuffle.shuffle on its list cast.&quot;&quot;&quot;</span>

    <span class="n">shuffled</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">shuffled</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shuffled</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">macro_link</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates a clickable hyperlink.</span>

<span class="sd">    Note:</span>
<span class="sd">        Since this is a pretty new feature for terminals, its support is limited.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="o">*</span><span class="n">uri_parts</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uri_parts</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">]8;;</span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="se">\x1b\\</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">\x1b</span><span class="s2">]8;;</span><span class="se">\x1b\\</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_apply_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies the given list of colors to the item, spread out evenly.&quot;&quot;&quot;</span>

    <span class="n">blocksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">current_block</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">blocksize</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">current_block</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">colors</span><span class="p">[</span><span class="n">current_block</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="n">current_block</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="n">char</span>

    <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">macro_rainbow</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates rainbow-colored text.&quot;&quot;&quot;</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;208&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;brightblue&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;93&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">_apply_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">macro_gradient</span><span class="p">(</span><span class="n">base_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates an xterm-256 gradient from a base color.</span>

<span class="sd">    This exploits the way the colors are arranged in the xterm color table; every</span>
<span class="sd">    36th color is the next item of a single gradient.</span>

<span class="sd">    The start of this given gradient is calculated by decreasing the given base by 36 on</span>
<span class="sd">    every iteration as long as the point is a valid gradient start.</span>

<span class="sd">    After that, the 6 colors of this gradient are calculated and applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gradient base has to be a digit, got </span><span class="si">{</span><span class="n">base_str</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="ow">or</span> <span class="n">base</span> <span class="o">&gt;</span> <span class="mi">231</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gradient base must be between 16 and 232&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">base</span> <span class="o">&gt;</span> <span class="mi">52</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">-=</span> <span class="mi">36</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_apply_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TokenType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Enum to store various token types.&quot;&quot;&quot;</span>

    <span class="n">PLAIN</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Plain text, nothing interesting.&quot;&quot;&quot;</span>

    <span class="n">STYLE</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;A builtin terminal style, such as `bold` or `italic`.&quot;&quot;&quot;</span>

    <span class="n">MACRO</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;A PTG markup macro. The macro itself is stored inside `self.data`.&quot;&quot;&quot;</span>

    <span class="n">ESCAPED</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;An escaped token.&quot;&quot;&quot;</span>

    <span class="n">FG_8BIT</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;8 bit (xterm-255) foreground color.&quot;&quot;&quot;</span>

    <span class="n">BG_8BIT</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;8 bit (xterm-255) background color.&quot;&quot;&quot;</span>

    <span class="n">FG_24BIT</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;24 bit (RGB) foreground color.&quot;&quot;&quot;</span>

    <span class="n">BG_24BIT</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;24 bit (RGB) background color.&quot;&quot;&quot;</span>

    <span class="n">UNSETTER</span> <span class="o">=</span> <span class="n">_auto</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;A token that unsets some other attribute.&quot;&quot;&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class holding information on a singular markup or ANSI style unit.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ttype</span><span class="p">:</span> <span class="n">TokenType</span>
    <span class="sd">&quot;&quot;&quot;The type of this token.&quot;&quot;&quot;</span>

    <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">MacroCall</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The data contained within this token. This changes based on the `ttype` attr.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;unnamed-token&gt;&quot;</span>
    <span class="sd">&quot;&quot;&quot;An optional display name of the token. Defaults to `data` when not given.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sets `name` to `data` if not provided.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&lt;unnamed-token&gt;&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Checks equality with `other`.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Token</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot check for equality between Token and non-Token of type&quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the ANSI sequence this token represents.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">STYLE</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span>

        <span class="c1"># Handle colors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;BG&quot;</span><span class="p">):</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[48;</span><span class="si">{c_id}</span><span class="s2">;&quot;</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[38;</span><span class="si">{c_id}</span><span class="s2">;&quot;</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_id</span><span class="o">=</span><span class="s2">&quot;5&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StyledText</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A styled text object.</span>

<span class="sd">    The purpose of this class is to implement some things regular `str`</span>
<span class="sd">    breaks at when encountering ANSI sequences.</span>

<span class="sd">    Instances of this class are usually spat out by `MarkupLanguage.parse`,</span>
<span class="sd">    but may be manually constructed if the need arises. Everything works even</span>
<span class="sd">    if there is no ANSI tomfoolery going on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;The underlying, ANSI-inclusive string value.&quot;&quot;&quot;</span>

    <span class="n">plain</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;The string value with no ANSI sequences.&quot;&quot;&quot;</span>

    <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;The list of tokens that make up this string.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a StyledText, gets markup tags.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_language: The markup language instance this object uses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">markup</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">plain</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>

        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">plain_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Finds given index inside plain text.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">styled_chars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">plain_chars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">negative_index</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">negative_index</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">styled_chars</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">plain_chars</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">negative_index</span><span class="p">:</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">plain_chars</span> <span class="o">+</span> <span class="n">styled_chars</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">styled_chars</span> <span class="o">+</span> <span class="n">plain_chars</span>

                <span class="n">plain_chars</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets &quot;real&quot; length of object.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscript</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets an item, adjusted for non-plain text.</span>

<span class="sd">        Args:</span>
<span class="sd">            subscript: The integer or slice to find.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The elements described by the subscript.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IndexError: The given index is out of range.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subscript</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">plain_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain_index</span><span class="p">(</span><span class="n">subscript</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plain_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;StyledText index out of range&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">plain_index</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span>
            <span class="nb">slice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plain_index</span><span class="p">(</span><span class="n">subscript</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plain_index</span><span class="p">(</span><span class="n">subscript</span><span class="o">.</span><span class="n">stop</span><span class="p">),</span>
                <span class="n">subscript</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">MarkupLanguage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class representing an instance of a Markup Language.</span>

<span class="sd">    This class is used for all markup/ANSI parsing, tokenizing and usage.</span>

<span class="sd">    ```python3</span>
<span class="sd">    from pytermgui import tim</span>

<span class="sd">    tim.alias(&quot;my-tag&quot;, &quot;@152 72 bold&quot;)</span>
<span class="sd">    tim.print(&quot;This is [my-tag]my-tag[/]!&quot;)</span>
<span class="sd">    ```</span>

<span class="sd">    &lt;p style=&quot;text-align: center&quot;&gt;</span>
<span class="sd">        &lt;img src=&quot;https://raw.githubusercontent.com/bczsalba/pytermgui/master/assets/\</span>
<span class="sd">docs/parser/markup_language.png&quot;</span>
<span class="sd">        style=&quot;width: 80%&quot;&gt;</span>
<span class="sd">    &lt;/p&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">raise_unknown_markup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Raise `pytermgui.exceptions.MarkupSyntaxError` when encountering unknown markup tags.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_macros</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initializes a MarkupLanguage.</span>

<span class="sd">        Args:</span>
<span class="sd">            default_macros: If not set, the builtin macros are not defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">STYLE_MAP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StyledText</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCallable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">UNSETTER_MAP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">should_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">default_macros</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!link&quot;</span><span class="p">,</span> <span class="n">macro_link</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!align&quot;</span><span class="p">,</span> <span class="n">macro_align</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!markup&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_markup</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!shuffle&quot;</span><span class="p">,</span> <span class="n">macro_shuffle</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!strip_bg&quot;</span><span class="p">,</span> <span class="n">macro_strip_bg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!strip_fg&quot;</span><span class="p">,</span> <span class="n">macro_strip_fg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!rainbow&quot;</span><span class="p">,</span> <span class="n">macro_rainbow</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!gradient&quot;</span><span class="p">,</span> <span class="n">macro_gradient</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!upper&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!lower&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!title&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">title</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!capitalize&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!expand&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">tag</span><span class="p">:</span> <span class="n">macro_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!debug&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ascii</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-int&quot;</span><span class="p">,</span> <span class="s2">&quot;175&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-str&quot;</span><span class="p">,</span> <span class="s2">&quot;142&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-type&quot;</span><span class="p">,</span> <span class="s2">&quot;214&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-none&quot;</span><span class="p">,</span> <span class="s2">&quot;167&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-name&quot;</span><span class="p">,</span> <span class="s2">&quot;pprint-type&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-file&quot;</span><span class="p">,</span> <span class="s2">&quot;109&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-keyword&quot;</span><span class="p">,</span> <span class="s2">&quot;203&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_color_token</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tries to get a color token from the given tag.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag: The tag to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A color token if the given tag could be parsed into one, else None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_hex_to_rgb</span><span class="p">(</span><span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Get rgb color from hex&quot;&quot;&quot;</span>

            <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">background</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="n">lookup_tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
            <span class="n">lookup_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">lookup_tag</span> <span class="ow">in</span> <span class="n">foreground</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">ttype</span><span class="o">=</span><span class="p">(</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">foreground</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">lookup_tag</span><span class="p">]),</span>
            <span class="p">)</span>

        <span class="n">data_256</span> <span class="o">=</span> <span class="n">RE_256</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lookup_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_256</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">ttype</span><span class="o">=</span><span class="p">(</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">lookup_tag</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">data_hex</span> <span class="o">=</span> <span class="n">RE_HEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lookup_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_hex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">ttype</span><span class="o">=</span><span class="p">(</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">_hex_to_rgb</span><span class="p">(</span><span class="n">lookup_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
            <span class="p">)</span>

        <span class="n">data_rgb</span> <span class="o">=</span> <span class="n">RE_RGB</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lookup_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_rgb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">ttype</span><span class="o">=</span><span class="p">(</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">lookup_tag</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_style_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tries to get a style (including unsetter) token from tags, user tags and unsetters.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag: The tag to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A `Token` if one could be created, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">STYLE</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">STYLE</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse all arguments and pass them through to print, along with kwargs.&quot;&quot;&quot;</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">parsed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">markup_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts the given markup string into an iterator of `Token`.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_text: The text to look at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An iterator of tokens. The reason this is an iterator is to possibly save</span>
<span class="sd">            on memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">RE_MARKUP</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">markup_text</span><span class="p">):</span>
            <span class="n">full</span><span class="p">,</span> <span class="n">escapes</span><span class="p">,</span> <span class="n">tag_text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>

            <span class="c1"># Add plain text between last and current match</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">markup_text</span><span class="p">[</span><span class="n">cursor</span><span class="p">:</span><span class="n">start</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">escapes</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">escapes</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>
                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">full</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">escapes</span><span class="p">)</span> <span class="p">:])</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_text</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_style_token</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">token</span>
                    <span class="k">continue</span>

                <span class="c1"># Try to find a color token</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_color_token</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">token</span>
                    <span class="k">continue</span>

                <span class="n">macro_match</span> <span class="o">=</span> <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">macro_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">macro_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="n">macro_args</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MarkupSyntaxError</span><span class="p">(</span>
                            <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                            <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;is not a defined macro&quot;</span><span class="p">,</span>
                            <span class="n">context</span><span class="o">=</span><span class="n">markup_text</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                        <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">macro_args</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_unknown_markup</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MarkupSyntaxError</span><span class="p">(</span>
                        <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;not defined&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">markup_text</span>
                    <span class="p">)</span>

            <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>

        <span class="c1"># Add remaining text as plain</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">markup_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">markup_text</span><span class="p">[</span><span class="n">cursor</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">tokenize_ansi</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ansi</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts the given ANSI string into an iterator of `Token`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ansi: The text to look at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An iterator of tokens. The reason this is an iterator is to possibly save</span>
<span class="sd">            on memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># StyledText messes with indexing, so we need to cast it</span>
        <span class="c1"># back to str.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ansi</span><span class="p">,</span> <span class="n">StyledText</span><span class="p">):</span>
            <span class="n">ansi</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ansi</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">RE_ANSI</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">plain</span> <span class="o">=</span> <span class="n">ansi</span><span class="p">[</span><span class="n">cursor</span><span class="p">:</span><span class="n">start</span><span class="p">]</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">plain</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">plain</span><span class="p">)</span>

            <span class="c1"># Styles &amp; unsetters</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">token_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">token_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">token_code</span> <span class="o">==</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">ttype</span> <span class="o">=</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">token_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">token_code</span> <span class="o">==</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">ttype</span> <span class="o">=</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">STYLE</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">raise</span> <span class="n">AnsiSyntaxError</span><span class="p">(</span>
                            <span class="n">tag</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;not recognized&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ansi</span>
                        <span class="p">)</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">token_code</span><span class="p">)</span>

            <span class="c1"># Colors</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

                <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;48&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">name</span>
                    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span><span class="p">]</span>

                <span class="n">ttype</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span> <span class="k">else</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>

        <span class="k">if</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="n">plain</span> <span class="o">=</span> <span class="n">ansi</span><span class="p">[</span><span class="n">cursor</span><span class="p">:]</span>

            <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">plain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">MacroCallable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Defines a Macro tag that executes the given method.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name the given method will be reachable by within markup.</span>
<span class="sd">                The given value gets &quot;!&quot; prepended if it isn&#39;t present already.</span>
<span class="sd">            method: The method this macro will execute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aliases the given name to a value, and generates an unsetter for it.</span>

<span class="sd">        Note that it is not possible to alias macros.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the new tag.</span>
<span class="sd">            value: The value the new tag will stand for.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_get_unsetter</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Get unsetter for a token&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;FG&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/fg&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;BG&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/bg&quot;</span><span class="p">]</span>

            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find unsetter for token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only macro tags can always start with &quot;!&quot;.&#39;</span><span class="p">)</span>

        <span class="n">setter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">unsetter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Try to link to existing tag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">setter</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>

            <span class="n">t_unsetter</span> <span class="o">=</span> <span class="n">_get_unsetter</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">t_unsetter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">unsetter</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">t_unsetter</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">unsetter</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">setter</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>

        <span class="n">marked</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">marked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">marked</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="c1"># TODO: I cannot cut down the one-too-many branch that this has at the moment.</span>
    <span class="c1">#       We could look into it in the future, however.</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">markup_text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StyledText</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parses the given markup.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_text: The markup to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A `StyledText` instance of the result of parsing the input. This</span>
<span class="sd">            custom `str` class is used to allow accessing the plain value of</span>
<span class="sd">            the output, as well as to cleanly index within it. It is analogous</span>
<span class="sd">            to builtin `str`, only adds extra things on top.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">applied_macros</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCall</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">previous_token</span><span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">previous_sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_apply_macros</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Apply current macros to text&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">text</span>

        <span class="k">def</span> <span class="nf">_is_same_colorgroup</span><span class="p">(</span><span class="n">previous</span><span class="p">:</span> <span class="n">Token</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">color_types</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">previous</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="n">color_types</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="n">color_types</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">prev_prefix</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">prev_prefix</span> <span class="o">==</span> <span class="n">prefix</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">markup_text</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_cache</span>
            <span class="ow">and</span> <span class="n">markup_text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">markup_text</span><span class="p">]</span>

        <span class="n">token</span><span class="p">:</span> <span class="n">Token</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="n">markup_text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sequence</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">previous_token</span> <span class="o">==</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Optimize out previously added color tokens, as only the most</span>
            <span class="c1"># recent would be visible anyways.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">previous_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">_is_same_colorgroup</span><span class="p">(</span><span class="n">previous_token</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="o">==</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">continue</span>

            <span class="n">previous_token</span> <span class="o">=</span> <span class="n">token</span>

            <span class="c1"># Macro unsetters are stored with None as their data</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                    <span class="n">macro_match</span> <span class="o">=</span> <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">macro_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                    <span class="n">macro_name</span> <span class="o">=</span> <span class="n">macro_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">macro_name</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">applied_macros</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

                <span class="n">applied_macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">applied</span> <span class="o">=</span> <span class="n">sequence</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">previous_sequence</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">item</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">item</span>
                    <span class="n">applied</span> <span class="o">=</span> <span class="n">applied</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">out</span> <span class="o">+=</span> <span class="n">applied</span> <span class="o">+</span> <span class="n">_apply_macros</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">previous_sequence</span> <span class="o">=</span> <span class="n">sequence</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">continue</span>

            <span class="n">sequence</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>

        <span class="k">if</span> <span class="n">sequence</span> <span class="o">+</span> <span class="n">previous_sequence</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">StyledText</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">markup_text</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">get_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ansi</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates markup from ANSI text.</span>

<span class="sd">        Args:</span>
<span class="sd">            ansi: The text to get markup from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A markup string that can be parsed to get (visually) the same</span>
<span class="sd">            result. Note that this conversion is lossy in a way: there are some</span>
<span class="sd">            details (like macros) that cannot be preserved in an ANSI-&gt;Markup-&gt;ANSI</span>
<span class="sd">            conversion.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">current_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_tags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_tags</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>

                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>
                <span class="n">current_tags</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">continue</span>

            <span class="n">current_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">prettify_ansi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a prettified (syntax-highlighted) ANSI str.</span>

<span class="sd">        This is useful to quickly &quot;inspect&quot; a given ANSI string. However,</span>
<span class="sd">        for most real uses `MarkupLanguage.prettify_markup` would be</span>
<span class="sd">        preferable, given an argument of `MarkupLanguage.get_markup(text)`,</span>
<span class="sd">        as it is much more verbose.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The ANSI-text to prettify.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The prettified ANSI text. This text&#39;s styles remain valid,</span>
<span class="sd">            so copy-pasting the argument into a command (like printf)</span>
<span class="sd">            that can show styled text will work the same way.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x1b&quot;</span><span class="p">)</span>
            <span class="n">sequences</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">sequences</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">prettify_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a prettified (syntax-highlighted) markup str.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The markup-text to prettify.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Prettified markup. This markup, excluding its styles,</span>
<span class="sd">            remains valid markup.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_apply_macros</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Apply current macros to text&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">text</span>

        <span class="k">def</span> <span class="nf">_pop_macro</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Pops a macro from applied_macros.&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">macro_name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">applied_macros</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">macro_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">applied_macros</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="n">styles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TokenType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span> <span class="s2">&quot;210&quot;</span><span class="p">,</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">:</span> <span class="s2">&quot;210 bold&quot;</span><span class="p">,</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span> <span class="s2">&quot;strikethrough&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">applied_macros</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCall</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">current_styles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">in_sequence</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>

                <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">current_styles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">style</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">sequence</span> <span class="o">+=</span> <span class="n">style</span><span class="o">.</span><span class="n">sequence</span>

                <span class="n">out</span> <span class="o">+=</span> <span class="n">sequence</span> <span class="o">+</span> <span class="n">_apply_macros</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
                <span class="k">continue</span>

            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">in_sequence</span> <span class="k">else</span> <span class="s2">&quot;[&quot;</span>
            <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span>
                    <span class="n">_pop_macro</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="n">current_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

                <span class="n">special_style</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;/[</span><span class="si">{</span><span class="n">special_style</span><span class="si">}{</span><span class="n">styles</span><span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">]</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)]</span>

                <span class="n">applied_macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="o">*</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># Not enough arguments</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

            <span class="n">style_markup</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="p">)</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">style_markup</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_sequence</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>

        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s2">&quot;[/]&quot;</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Main method&quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="n">markup_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;Markup-&gt;ANSI&quot;</span><span class="p">)</span>
    <span class="n">markup_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--parse&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;TXT&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parse a markup text&quot;</span>
    <span class="p">)</span>
    <span class="n">markup_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--escape&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;escape parsed markup&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span>
    <span class="p">)</span>
    <span class="c1"># markup_group.add_argument(</span>
    <span class="c1"># &quot;-o&quot;,</span>
    <span class="c1"># &quot;--optimize&quot;,</span>
    <span class="c1"># help=&quot;set optimization level for markup parsing&quot;,</span>
    <span class="c1"># action=&quot;count&quot;,</span>
    <span class="c1"># default=0,</span>
    <span class="c1"># )</span>

    <span class="n">markup_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--alias&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;alias src=dst&quot;</span><span class="p">)</span>

    <span class="n">ansi_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;ANSI-&gt;Markup&quot;</span><span class="p">)</span>
    <span class="n">ansi_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--markup&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;TXT&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;get markup from ANSI text&quot;</span>
    <span class="p">)</span>
    <span class="n">ansi_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--show-inverse&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show result of parsing result markup&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">lang</span> <span class="o">=</span> <span class="n">MarkupLanguage</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">markup</span><span class="p">:</span>
        <span class="n">markup_text</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">get_markup</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">markup</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">markup_text</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">show_inverse</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">lang</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">markup_text</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">parse</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span>
                <span class="n">src</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">alias</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                <span class="n">lang</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">escape</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ascii</span><span class="p">(</span><span class="n">parsed</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>

        <span class="k">return</span>


<span class="n">tim</span> <span class="o">=</span> <span class="n">markup</span> <span class="o">=</span> <span class="n">MarkupLanguage</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;The default TIM instances.&quot;&quot;&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

        </details>

            </section>
                <section id="MacroCallable">
                                <div class="attr variable"><a class="headerlink" href="#MacroCallable">#&nbsp;&nbsp</a>

        <span class="name">MacroCallable</span><span class="default_value"> = typing.Callable[..., str]</span>
    </div>

    
    

                </section>
                <section id="MacroCall">
                                <div class="attr variable"><a class="headerlink" href="#MacroCall">#&nbsp;&nbsp</a>

        <span class="name">MacroCall</span><span class="default_value"> = typing.Tuple[typing.Callable[..., str], typing.List[str]]</span>
    </div>

    
    

                </section>
                <section id="MarkupLanguage">
                                <div class="attr class">
        <a class="headerlink" href="#MarkupLanguage">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">MarkupLanguage</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MarkupLanguage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class representing an instance of a Markup Language.</span>

<span class="sd">    This class is used for all markup/ANSI parsing, tokenizing and usage.</span>

<span class="sd">    ```python3</span>
<span class="sd">    from pytermgui import tim</span>

<span class="sd">    tim.alias(&quot;my-tag&quot;, &quot;@152 72 bold&quot;)</span>
<span class="sd">    tim.print(&quot;This is [my-tag]my-tag[/]!&quot;)</span>
<span class="sd">    ```</span>

<span class="sd">    &lt;p style=&quot;text-align: center&quot;&gt;</span>
<span class="sd">        &lt;img src=&quot;https://raw.githubusercontent.com/bczsalba/pytermgui/master/assets/\</span>
<span class="sd">docs/parser/markup_language.png&quot;</span>
<span class="sd">        style=&quot;width: 80%&quot;&gt;</span>
<span class="sd">    &lt;/p&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">raise_unknown_markup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Raise `pytermgui.exceptions.MarkupSyntaxError` when encountering unknown markup tags.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_macros</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initializes a MarkupLanguage.</span>

<span class="sd">        Args:</span>
<span class="sd">            default_macros: If not set, the builtin macros are not defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">STYLE_MAP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StyledText</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCallable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">UNSETTER_MAP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">should_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">default_macros</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!link&quot;</span><span class="p">,</span> <span class="n">macro_link</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!align&quot;</span><span class="p">,</span> <span class="n">macro_align</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!markup&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_markup</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!shuffle&quot;</span><span class="p">,</span> <span class="n">macro_shuffle</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!strip_bg&quot;</span><span class="p">,</span> <span class="n">macro_strip_bg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!strip_fg&quot;</span><span class="p">,</span> <span class="n">macro_strip_fg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!rainbow&quot;</span><span class="p">,</span> <span class="n">macro_rainbow</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!gradient&quot;</span><span class="p">,</span> <span class="n">macro_gradient</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!upper&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!lower&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!title&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">title</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!capitalize&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!expand&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">tag</span><span class="p">:</span> <span class="n">macro_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!debug&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ascii</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-int&quot;</span><span class="p">,</span> <span class="s2">&quot;175&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-str&quot;</span><span class="p">,</span> <span class="s2">&quot;142&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-type&quot;</span><span class="p">,</span> <span class="s2">&quot;214&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-none&quot;</span><span class="p">,</span> <span class="s2">&quot;167&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-name&quot;</span><span class="p">,</span> <span class="s2">&quot;pprint-type&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-file&quot;</span><span class="p">,</span> <span class="s2">&quot;109&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-keyword&quot;</span><span class="p">,</span> <span class="s2">&quot;203&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_color_token</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tries to get a color token from the given tag.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag: The tag to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A color token if the given tag could be parsed into one, else None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_hex_to_rgb</span><span class="p">(</span><span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Get rgb color from hex&quot;&quot;&quot;</span>

            <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">background</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="n">lookup_tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
            <span class="n">lookup_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">lookup_tag</span> <span class="ow">in</span> <span class="n">foreground</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">ttype</span><span class="o">=</span><span class="p">(</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">foreground</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">lookup_tag</span><span class="p">]),</span>
            <span class="p">)</span>

        <span class="n">data_256</span> <span class="o">=</span> <span class="n">RE_256</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lookup_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_256</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">ttype</span><span class="o">=</span><span class="p">(</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">lookup_tag</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">data_hex</span> <span class="o">=</span> <span class="n">RE_HEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lookup_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_hex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">ttype</span><span class="o">=</span><span class="p">(</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">_hex_to_rgb</span><span class="p">(</span><span class="n">lookup_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
            <span class="p">)</span>

        <span class="n">data_rgb</span> <span class="o">=</span> <span class="n">RE_RGB</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lookup_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_rgb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">ttype</span><span class="o">=</span><span class="p">(</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">lookup_tag</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_style_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Token</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tries to get a style (including unsetter) token from tags, user tags and unsetters.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag: The tag to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A `Token` if one could be created, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">STYLE</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">STYLE</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse all arguments and pass them through to print, along with kwargs.&quot;&quot;&quot;</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">parsed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">markup_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts the given markup string into an iterator of `Token`.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_text: The text to look at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An iterator of tokens. The reason this is an iterator is to possibly save</span>
<span class="sd">            on memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">RE_MARKUP</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">markup_text</span><span class="p">):</span>
            <span class="n">full</span><span class="p">,</span> <span class="n">escapes</span><span class="p">,</span> <span class="n">tag_text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>

            <span class="c1"># Add plain text between last and current match</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">markup_text</span><span class="p">[</span><span class="n">cursor</span><span class="p">:</span><span class="n">start</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">escapes</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">escapes</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>
                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">full</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">escapes</span><span class="p">)</span> <span class="p">:])</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_text</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_style_token</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">token</span>
                    <span class="k">continue</span>

                <span class="c1"># Try to find a color token</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_color_token</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">token</span>
                    <span class="k">continue</span>

                <span class="n">macro_match</span> <span class="o">=</span> <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">macro_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">macro_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="n">macro_args</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MarkupSyntaxError</span><span class="p">(</span>
                            <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                            <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;is not a defined macro&quot;</span><span class="p">,</span>
                            <span class="n">context</span><span class="o">=</span><span class="n">markup_text</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                        <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">macro_args</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_unknown_markup</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MarkupSyntaxError</span><span class="p">(</span>
                        <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;not defined&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">markup_text</span>
                    <span class="p">)</span>

            <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>

        <span class="c1"># Add remaining text as plain</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">markup_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">markup_text</span><span class="p">[</span><span class="n">cursor</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">tokenize_ansi</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ansi</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts the given ANSI string into an iterator of `Token`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ansi: The text to look at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An iterator of tokens. The reason this is an iterator is to possibly save</span>
<span class="sd">            on memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># StyledText messes with indexing, so we need to cast it</span>
        <span class="c1"># back to str.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ansi</span><span class="p">,</span> <span class="n">StyledText</span><span class="p">):</span>
            <span class="n">ansi</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ansi</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">RE_ANSI</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">plain</span> <span class="o">=</span> <span class="n">ansi</span><span class="p">[</span><span class="n">cursor</span><span class="p">:</span><span class="n">start</span><span class="p">]</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">plain</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">plain</span><span class="p">)</span>

            <span class="c1"># Styles &amp; unsetters</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">token_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">token_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">token_code</span> <span class="o">==</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">ttype</span> <span class="o">=</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">token_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">token_code</span> <span class="o">==</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">ttype</span> <span class="o">=</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">STYLE</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">raise</span> <span class="n">AnsiSyntaxError</span><span class="p">(</span>
                            <span class="n">tag</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;not recognized&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ansi</span>
                        <span class="p">)</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">token_code</span><span class="p">)</span>

            <span class="c1"># Colors</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

                <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;48&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">name</span>
                    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span><span class="p">]</span>

                <span class="n">ttype</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span> <span class="k">else</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>

        <span class="k">if</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="n">plain</span> <span class="o">=</span> <span class="n">ansi</span><span class="p">[</span><span class="n">cursor</span><span class="p">:]</span>

            <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">plain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">MacroCallable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Defines a Macro tag that executes the given method.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name the given method will be reachable by within markup.</span>
<span class="sd">                The given value gets &quot;!&quot; prepended if it isn&#39;t present already.</span>
<span class="sd">            method: The method this macro will execute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aliases the given name to a value, and generates an unsetter for it.</span>

<span class="sd">        Note that it is not possible to alias macros.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the new tag.</span>
<span class="sd">            value: The value the new tag will stand for.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_get_unsetter</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Get unsetter for a token&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;FG&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/fg&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;BG&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/bg&quot;</span><span class="p">]</span>

            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find unsetter for token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only macro tags can always start with &quot;!&quot;.&#39;</span><span class="p">)</span>

        <span class="n">setter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">unsetter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Try to link to existing tag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">setter</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>

            <span class="n">t_unsetter</span> <span class="o">=</span> <span class="n">_get_unsetter</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">t_unsetter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">unsetter</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">t_unsetter</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">unsetter</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">setter</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>

        <span class="n">marked</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">marked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">marked</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="c1"># TODO: I cannot cut down the one-too-many branch that this has at the moment.</span>
    <span class="c1">#       We could look into it in the future, however.</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">markup_text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StyledText</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parses the given markup.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_text: The markup to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A `StyledText` instance of the result of parsing the input. This</span>
<span class="sd">            custom `str` class is used to allow accessing the plain value of</span>
<span class="sd">            the output, as well as to cleanly index within it. It is analogous</span>
<span class="sd">            to builtin `str`, only adds extra things on top.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">applied_macros</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCall</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">previous_token</span><span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">previous_sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_apply_macros</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Apply current macros to text&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">text</span>

        <span class="k">def</span> <span class="nf">_is_same_colorgroup</span><span class="p">(</span><span class="n">previous</span><span class="p">:</span> <span class="n">Token</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">color_types</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">previous</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="n">color_types</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="n">color_types</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">prev_prefix</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">prev_prefix</span> <span class="o">==</span> <span class="n">prefix</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">markup_text</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_cache</span>
            <span class="ow">and</span> <span class="n">markup_text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">markup_text</span><span class="p">]</span>

        <span class="n">token</span><span class="p">:</span> <span class="n">Token</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="n">markup_text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sequence</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">previous_token</span> <span class="o">==</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Optimize out previously added color tokens, as only the most</span>
            <span class="c1"># recent would be visible anyways.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">previous_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">_is_same_colorgroup</span><span class="p">(</span><span class="n">previous_token</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="o">==</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">continue</span>

            <span class="n">previous_token</span> <span class="o">=</span> <span class="n">token</span>

            <span class="c1"># Macro unsetters are stored with None as their data</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                    <span class="n">macro_match</span> <span class="o">=</span> <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">macro_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                    <span class="n">macro_name</span> <span class="o">=</span> <span class="n">macro_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">macro_name</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">applied_macros</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

                <span class="n">applied_macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">applied</span> <span class="o">=</span> <span class="n">sequence</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">previous_sequence</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">item</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">item</span>
                    <span class="n">applied</span> <span class="o">=</span> <span class="n">applied</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">out</span> <span class="o">+=</span> <span class="n">applied</span> <span class="o">+</span> <span class="n">_apply_macros</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">previous_sequence</span> <span class="o">=</span> <span class="n">sequence</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">continue</span>

            <span class="n">sequence</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>

        <span class="k">if</span> <span class="n">sequence</span> <span class="o">+</span> <span class="n">previous_sequence</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">StyledText</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">markup_text</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">get_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ansi</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates markup from ANSI text.</span>

<span class="sd">        Args:</span>
<span class="sd">            ansi: The text to get markup from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A markup string that can be parsed to get (visually) the same</span>
<span class="sd">            result. Note that this conversion is lossy in a way: there are some</span>
<span class="sd">            details (like macros) that cannot be preserved in an ANSI-&gt;Markup-&gt;ANSI</span>
<span class="sd">            conversion.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">current_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_tags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_tags</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>

                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>
                <span class="n">current_tags</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">continue</span>

            <span class="n">current_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">prettify_ansi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a prettified (syntax-highlighted) ANSI str.</span>

<span class="sd">        This is useful to quickly &quot;inspect&quot; a given ANSI string. However,</span>
<span class="sd">        for most real uses `MarkupLanguage.prettify_markup` would be</span>
<span class="sd">        preferable, given an argument of `MarkupLanguage.get_markup(text)`,</span>
<span class="sd">        as it is much more verbose.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The ANSI-text to prettify.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The prettified ANSI text. This text&#39;s styles remain valid,</span>
<span class="sd">            so copy-pasting the argument into a command (like printf)</span>
<span class="sd">            that can show styled text will work the same way.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x1b&quot;</span><span class="p">)</span>
            <span class="n">sequences</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">sequences</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">prettify_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a prettified (syntax-highlighted) markup str.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The markup-text to prettify.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Prettified markup. This markup, excluding its styles,</span>
<span class="sd">            remains valid markup.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_apply_macros</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Apply current macros to text&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">text</span>

        <span class="k">def</span> <span class="nf">_pop_macro</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Pops a macro from applied_macros.&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">macro_name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">applied_macros</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">macro_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">applied_macros</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="n">styles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TokenType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span> <span class="s2">&quot;210&quot;</span><span class="p">,</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">:</span> <span class="s2">&quot;210 bold&quot;</span><span class="p">,</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span> <span class="s2">&quot;strikethrough&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">applied_macros</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCall</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">current_styles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">in_sequence</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>

                <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">current_styles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">style</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">sequence</span> <span class="o">+=</span> <span class="n">style</span><span class="o">.</span><span class="n">sequence</span>

                <span class="n">out</span> <span class="o">+=</span> <span class="n">sequence</span> <span class="o">+</span> <span class="n">_apply_macros</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
                <span class="k">continue</span>

            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">in_sequence</span> <span class="k">else</span> <span class="s2">&quot;[&quot;</span>
            <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span>
                    <span class="n">_pop_macro</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="n">current_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

                <span class="n">special_style</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;/[</span><span class="si">{</span><span class="n">special_style</span><span class="si">}{</span><span class="n">styles</span><span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">]</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)]</span>

                <span class="n">applied_macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="o">*</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># Not enough arguments</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

            <span class="n">style_markup</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="p">)</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">style_markup</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_sequence</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>

        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s2">&quot;[/]&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>A class representing an instance of a Markup Language.</p>

<p>This class is used for all markup/ANSI parsing, tokenizing and usage.</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytermgui</span> <span class="kn">import</span> <span class="n">tim</span>

<span class="n">tim</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;my-tag&quot;</span><span class="p">,</span> <span class="s2">&quot;@152 72 bold&quot;</span><span class="p">)</span>
<span class="n">tim</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;This is [my-tag]my-tag[/]!&quot;</span><span class="p">)</span>
</code></pre></div>

<p style="text-align: center">
    <img src="https://raw.githubusercontent.com/bczsalba/pytermgui/master/assets/docs/parser/markup_language.png"
    style="width: 80%">
</p>
</div>


                            <div id="MarkupLanguage.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">MarkupLanguage</span><span class="signature">(default_macros: bool = True)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_macros</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initializes a MarkupLanguage.</span>

<span class="sd">        Args:</span>
<span class="sd">            default_macros: If not set, the builtin macros are not defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">STYLE_MAP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StyledText</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCallable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">UNSETTER_MAP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">should_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">default_macros</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!link&quot;</span><span class="p">,</span> <span class="n">macro_link</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!align&quot;</span><span class="p">,</span> <span class="n">macro_align</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!markup&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_markup</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!shuffle&quot;</span><span class="p">,</span> <span class="n">macro_shuffle</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!strip_bg&quot;</span><span class="p">,</span> <span class="n">macro_strip_bg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!strip_fg&quot;</span><span class="p">,</span> <span class="n">macro_strip_fg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!rainbow&quot;</span><span class="p">,</span> <span class="n">macro_rainbow</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!gradient&quot;</span><span class="p">,</span> <span class="n">macro_gradient</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!upper&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!lower&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!title&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">title</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!capitalize&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!expand&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">tag</span><span class="p">:</span> <span class="n">macro_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="s2">&quot;!debug&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ascii</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-int&quot;</span><span class="p">,</span> <span class="s2">&quot;175&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-str&quot;</span><span class="p">,</span> <span class="s2">&quot;142&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-type&quot;</span><span class="p">,</span> <span class="s2">&quot;214&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pprint-none&quot;</span><span class="p">,</span> <span class="s2">&quot;167&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-name&quot;</span><span class="p">,</span> <span class="s2">&quot;pprint-type&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-file&quot;</span><span class="p">,</span> <span class="s2">&quot;109&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;inspector-keyword&quot;</span><span class="p">,</span> <span class="s2">&quot;203&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initializes a MarkupLanguage.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>default_macros:</strong>  If not set, the builtin macros are not defined.</li>
</ul>
</div>


                            </div>
                            <div id="MarkupLanguage.raise_unknown_markup" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#MarkupLanguage.raise_unknown_markup">#&nbsp;&nbsp</a>

        <span class="name">raise_unknown_markup</span><span class="annotation">: bool</span><span class="default_value"> = False</span>
    </div>

    
            <div class="docstring"><p>Raise <code><a href="exceptions.html#MarkupSyntaxError">pytermgui.exceptions.MarkupSyntaxError</a></code> when encountering unknown markup tags.</p>
</div>


                            </div>
                            <div id="MarkupLanguage.print" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.print">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">print</span><span class="signature">(self, *args, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse all arguments and pass them through to print, along with kwargs.&quot;&quot;&quot;</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">parsed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">parsed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parse all arguments and pass them through to print, along with kwargs.</p>
</div>


                            </div>
                            <div id="MarkupLanguage.tokenize_markup" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.tokenize_markup">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">tokenize_markup</span><span class="signature">(self, markup_text: str) -&gt; Iterator[pytermgui.parser.Token]</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">tokenize_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">markup_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts the given markup string into an iterator of `Token`.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_text: The text to look at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An iterator of tokens. The reason this is an iterator is to possibly save</span>
<span class="sd">            on memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">RE_MARKUP</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">markup_text</span><span class="p">):</span>
            <span class="n">full</span><span class="p">,</span> <span class="n">escapes</span><span class="p">,</span> <span class="n">tag_text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>

            <span class="c1"># Add plain text between last and current match</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">markup_text</span><span class="p">[</span><span class="n">cursor</span><span class="p">:</span><span class="n">start</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">escapes</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">escapes</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>
                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">full</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">escapes</span><span class="p">)</span> <span class="p">:])</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_text</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_style_token</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">token</span>
                    <span class="k">continue</span>

                <span class="c1"># Try to find a color token</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_color_token</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">token</span>
                    <span class="k">continue</span>

                <span class="n">macro_match</span> <span class="o">=</span> <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">macro_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">macro_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="n">macro_args</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MarkupSyntaxError</span><span class="p">(</span>
                            <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                            <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;is not a defined macro&quot;</span><span class="p">,</span>
                            <span class="n">context</span><span class="o">=</span><span class="n">markup_text</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                        <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">macro_args</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_unknown_markup</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MarkupSyntaxError</span><span class="p">(</span>
                        <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;not defined&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">markup_text</span>
                    <span class="p">)</span>

            <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>

        <span class="c1"># Add remaining text as plain</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">markup_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">markup_text</span><span class="p">[</span><span class="n">cursor</span><span class="p">:])</span>
</pre></div>

        </details>

            <div class="docstring"><p>Converts the given markup string into an iterator of <code>Token</code>.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>markup_text:</strong>  The text to look at.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>An iterator of tokens. The reason this is an iterator is to possibly save
  on memory.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkupLanguage.tokenize_ansi" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.tokenize_ansi">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">tokenize_ansi</span><span class="signature">(self, ansi: str) -&gt; Iterator[pytermgui.parser.Token]</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">tokenize_ansi</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ansi</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts the given ANSI string into an iterator of `Token`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ansi: The text to look at.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An iterator of tokens. The reason this is an iterator is to possibly save</span>
<span class="sd">            on memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># StyledText messes with indexing, so we need to cast it</span>
        <span class="c1"># back to str.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ansi</span><span class="p">,</span> <span class="n">StyledText</span><span class="p">):</span>
            <span class="n">ansi</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ansi</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">RE_ANSI</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">plain</span> <span class="o">=</span> <span class="n">ansi</span><span class="p">[</span><span class="n">cursor</span><span class="p">:</span><span class="n">start</span><span class="p">]</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">plain</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">plain</span><span class="p">)</span>

            <span class="c1"># Styles &amp; unsetters</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">token_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">token_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">token_code</span> <span class="o">==</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">ttype</span> <span class="o">=</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">token_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">token_code</span> <span class="o">==</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">ttype</span> <span class="o">=</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">STYLE</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">raise</span> <span class="n">AnsiSyntaxError</span><span class="p">(</span>
                            <span class="n">tag</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;not recognized&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ansi</span>
                        <span class="p">)</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">token_code</span><span class="p">)</span>

            <span class="c1"># Colors</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

                <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;48&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">name</span>
                    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span><span class="p">]</span>

                <span class="n">ttype</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span> <span class="k">else</span> <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="n">cursor</span> <span class="o">=</span> <span class="n">end</span>

        <span class="k">if</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="n">plain</span> <span class="o">=</span> <span class="n">ansi</span><span class="p">[</span><span class="n">cursor</span><span class="p">:]</span>

            <span class="k">yield</span> <span class="n">Token</span><span class="p">(</span><span class="n">ttype</span><span class="o">=</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">plain</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Converts the given ANSI string into an iterator of <code>Token</code>.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>ansi:</strong>  The text to look at.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>An iterator of tokens. The reason this is an iterator is to possibly save
  on memory.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkupLanguage.define" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.define">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">define</span><span class="signature">(self, name: str, method: Callable[..., str]) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">MacroCallable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Defines a Macro tag that executes the given method.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name the given method will be reachable by within markup.</span>
<span class="sd">                The given value gets &quot;!&quot; prepended if it isn&#39;t present already.</span>
<span class="sd">            method: The method this macro will execute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

        </details>

            <div class="docstring"><p>Defines a Macro tag that executes the given method.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>name:</strong>  The name the given method will be reachable by within markup.
The given value gets "!" prepended if it isn't present already.</li>
<li><strong>method:</strong>  The method this macro will execute.</li>
</ul>
</div>


                            </div>
                            <div id="MarkupLanguage.alias" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.alias">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">alias</span><span class="signature">(self, name: str, value: str) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aliases the given name to a value, and generates an unsetter for it.</span>

<span class="sd">        Note that it is not possible to alias macros.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the new tag.</span>
<span class="sd">            value: The value the new tag will stand for.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_get_unsetter</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Get unsetter for a token&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;FG&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/fg&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;BG&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/bg&quot;</span><span class="p">]</span>

            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find unsetter for token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only macro tags can always start with &quot;!&quot;.&#39;</span><span class="p">)</span>

        <span class="n">setter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">unsetter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Try to link to existing tag</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">setter</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>

            <span class="n">t_unsetter</span> <span class="o">=</span> <span class="n">_get_unsetter</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">t_unsetter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">unsetter</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">t_unsetter</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unsetters</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">unsetter</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">setter</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>

        <span class="n">marked</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">marked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">marked</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>Aliases the given name to a value, and generates an unsetter for it.</p>

<p>Note that it is not possible to alias macros.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>name:</strong>  The name of the new tag.</li>
<li><strong>value:</strong>  The value the new tag will stand for.</li>
</ul>
</div>


                            </div>
                            <div id="MarkupLanguage.parse" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.parse">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">parse</span><span class="signature">(self, markup_text: str) -&gt; <a href="#StyledText">pytermgui.parser.StyledText</a></span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">markup_text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StyledText</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parses the given markup.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_text: The markup to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A `StyledText` instance of the result of parsing the input. This</span>
<span class="sd">            custom `str` class is used to allow accessing the plain value of</span>
<span class="sd">            the output, as well as to cleanly index within it. It is analogous</span>
<span class="sd">            to builtin `str`, only adds extra things on top.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">applied_macros</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCall</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">previous_token</span><span class="p">:</span> <span class="n">Token</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">previous_sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_apply_macros</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Apply current macros to text&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">text</span>

        <span class="k">def</span> <span class="nf">_is_same_colorgroup</span><span class="p">(</span><span class="n">previous</span><span class="p">:</span> <span class="n">Token</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">color_types</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_8BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_8BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">FG_24BIT</span><span class="p">,</span>
                <span class="n">TokenType</span><span class="o">.</span><span class="n">BG_24BIT</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">previous</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="n">color_types</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="n">color_types</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">prev_prefix</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">ttype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">prev_prefix</span> <span class="o">==</span> <span class="n">prefix</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">markup_text</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_cache</span>
            <span class="ow">and</span> <span class="n">markup_text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">markup_text</span><span class="p">]</span>

        <span class="n">token</span><span class="p">:</span> <span class="n">Token</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="n">markup_text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sequence</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">previous_token</span> <span class="o">==</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Optimize out previously added color tokens, as only the most</span>
            <span class="c1"># recent would be visible anyways.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">previous_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">_is_same_colorgroup</span><span class="p">(</span><span class="n">previous_token</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="o">==</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">continue</span>

            <span class="n">previous_token</span> <span class="o">=</span> <span class="n">token</span>

            <span class="c1"># Macro unsetters are stored with None as their data</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                    <span class="n">macro_match</span> <span class="o">=</span> <span class="n">RE_MACRO</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">macro_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                    <span class="n">macro_name</span> <span class="o">=</span> <span class="n">macro_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">macro_name</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">applied_macros</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

                <span class="n">applied_macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">applied</span> <span class="o">=</span> <span class="n">sequence</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">previous_sequence</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">item</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">item</span>
                    <span class="n">applied</span> <span class="o">=</span> <span class="n">applied</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">out</span> <span class="o">+=</span> <span class="n">applied</span> <span class="o">+</span> <span class="n">_apply_macros</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">previous_sequence</span> <span class="o">=</span> <span class="n">sequence</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">continue</span>

            <span class="n">sequence</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>

        <span class="k">if</span> <span class="n">sequence</span> <span class="o">+</span> <span class="n">previous_sequence</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">StyledText</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">markup_text</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parses the given markup.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>markup_text:</strong>  The markup to parse.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A <code><a href="#StyledText">StyledText</a></code> instance of the result of parsing the input. This
  custom <code>str</code> class is used to allow accessing the plain value of
  the output, as well as to cleanly index within it. It is analogous
  to builtin <code>str</code>, only adds extra things on top.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkupLanguage.get_markup" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.get_markup">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_markup</span><span class="signature">(self, ansi: str) -&gt; str</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ansi</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates markup from ANSI text.</span>

<span class="sd">        Args:</span>
<span class="sd">            ansi: The text to get markup from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A markup string that can be parsed to get (visually) the same</span>
<span class="sd">            result. Note that this conversion is lossy in a way: there are some</span>
<span class="sd">            details (like macros) that cannot be preserved in an ANSI-&gt;Markup-&gt;ANSI</span>
<span class="sd">            conversion.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">current_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">ansi</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_tags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_tags</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>

                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>
                <span class="n">current_tags</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">continue</span>

            <span class="n">current_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>
</pre></div>

        </details>

            <div class="docstring"><p>Generates markup from ANSI text.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>ansi:</strong>  The text to get markup from.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A markup string that can be parsed to get (visually) the same
  result. Note that this conversion is lossy in a way: there are some
  details (like macros) that cannot be preserved in an ANSI->Markup->ANSI
  conversion.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkupLanguage.prettify_ansi" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.prettify_ansi">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">prettify_ansi</span><span class="signature">(self, text: str) -&gt; str</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">prettify_ansi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a prettified (syntax-highlighted) ANSI str.</span>

<span class="sd">        This is useful to quickly &quot;inspect&quot; a given ANSI string. However,</span>
<span class="sd">        for most real uses `MarkupLanguage.prettify_markup` would be</span>
<span class="sd">        preferable, given an argument of `MarkupLanguage.get_markup(text)`,</span>
<span class="sd">        as it is much more verbose.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The ANSI-text to prettify.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The prettified ANSI text. This text&#39;s styles remain valid,</span>
<span class="sd">            so copy-pasting the argument into a command (like printf)</span>
<span class="sd">            that can show styled text will work the same way.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x1b&quot;</span><span class="p">)</span>
            <span class="n">sequences</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">sequences</span>

        <span class="k">return</span> <span class="n">out</span>
</pre></div>

        </details>

            <div class="docstring"><p>Returns a prettified (syntax-highlighted) ANSI str.</p>

<p>This is useful to quickly "inspect" a given ANSI string. However,
for most real uses <code><a href="#MarkupLanguage.prettify_markup">MarkupLanguage.prettify_markup</a></code> would be
preferable, given an argument of <code><a href="#MarkupLanguage.get_markup">MarkupLanguage.get_markup</a>(text)</code>,
as it is much more verbose.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>text:</strong>  The ANSI-text to prettify.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>The prettified ANSI text. This text's styles remain valid,
  so copy-pasting the argument into a command (like printf)
  that can show styled text will work the same way.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkupLanguage.prettify_markup" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MarkupLanguage.prettify_markup">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">prettify_markup</span><span class="signature">(self, text: str) -&gt; str</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">prettify_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a prettified (syntax-highlighted) markup str.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The markup-text to prettify.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Prettified markup. This markup, excluding its styles,</span>
<span class="sd">            remains valid markup.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_apply_macros</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Apply current macros to text&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="n">applied_macros</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">text</span>

        <span class="k">def</span> <span class="nf">_pop_macro</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Pops a macro from applied_macros.&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">macro_name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">applied_macros</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">macro_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">applied_macros</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="n">styles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TokenType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span> <span class="s2">&quot;210&quot;</span><span class="p">,</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">:</span> <span class="s2">&quot;210 bold&quot;</span><span class="p">,</span>
            <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span> <span class="s2">&quot;strikethrough&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">applied_macros</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MacroCall</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">current_styles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_markup</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">,</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">ESCAPED</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">in_sequence</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>

                <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">current_styles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">style</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">sequence</span> <span class="o">+=</span> <span class="n">style</span><span class="o">.</span><span class="n">sequence</span>

                <span class="n">out</span> <span class="o">+=</span> <span class="n">sequence</span> <span class="o">+</span> <span class="n">_apply_macros</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
                <span class="k">continue</span>

            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">in_sequence</span> <span class="k">else</span> <span class="s2">&quot;[&quot;</span>
            <span class="n">in_sequence</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">:</span>
                    <span class="n">_pop_macro</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="n">current_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

                <span class="n">special_style</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tags</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;/[</span><span class="si">{</span><span class="n">special_style</span><span class="si">}{</span><span class="n">styles</span><span class="p">[</span><span class="n">TokenType</span><span class="o">.</span><span class="n">UNSETTER</span><span class="p">]</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">MACRO</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)]</span>

                <span class="n">applied_macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="o">*</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># Not enough arguments</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

            <span class="n">style_markup</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">ttype</span><span class="p">)</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">name</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">style_markup</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_sequence</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>

        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s2">&quot;[/]&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>Returns a prettified (syntax-highlighted) markup str.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>text:</strong>  The markup-text to prettify.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Prettified markup. This markup, excluding its styles,
  remains valid markup.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="StyledText">
                                <div class="attr class">
        <a class="headerlink" href="#StyledText">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">StyledText</span><wbr>(<span class="base">builtins.str</span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StyledText</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A styled text object.</span>

<span class="sd">    The purpose of this class is to implement some things regular `str`</span>
<span class="sd">    breaks at when encountering ANSI sequences.</span>

<span class="sd">    Instances of this class are usually spat out by `MarkupLanguage.parse`,</span>
<span class="sd">    but may be manually constructed if the need arises. Everything works even</span>
<span class="sd">    if there is no ANSI tomfoolery going on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;The underlying, ANSI-inclusive string value.&quot;&quot;&quot;</span>

    <span class="n">plain</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;The string value with no ANSI sequences.&quot;&quot;&quot;</span>

    <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;The list of tokens that make up this string.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a StyledText, gets markup tags.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_language: The markup language instance this object uses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">markup</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">plain</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>

        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">plain_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Finds given index inside plain text.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">styled_chars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">plain_chars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">negative_index</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">negative_index</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">styled_chars</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">plain_chars</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">negative_index</span><span class="p">:</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">plain_chars</span> <span class="o">+</span> <span class="n">styled_chars</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">styled_chars</span> <span class="o">+</span> <span class="n">plain_chars</span>

                <span class="n">plain_chars</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets &quot;real&quot; length of object.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plain</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscript</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets an item, adjusted for non-plain text.</span>

<span class="sd">        Args:</span>
<span class="sd">            subscript: The integer or slice to find.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The elements described by the subscript.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IndexError: The given index is out of range.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subscript</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">plain_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plain_index</span><span class="p">(</span><span class="n">subscript</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plain_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;StyledText index out of range&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">plain_index</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span>
            <span class="nb">slice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plain_index</span><span class="p">(</span><span class="n">subscript</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plain_index</span><span class="p">(</span><span class="n">subscript</span><span class="o">.</span><span class="n">stop</span><span class="p">),</span>
                <span class="n">subscript</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>A styled text object.</p>

<p>The purpose of this class is to implement some things regular <code>str</code>
breaks at when encountering ANSI sequences.</p>

<p>Instances of this class are usually spat out by <code><a href="#MarkupLanguage.parse">MarkupLanguage.parse</a></code>,
but may be manually constructed if the need arises. Everything works even
if there is no ANSI tomfoolery going on.</p>
</div>


                            <div id="StyledText.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#StyledText.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">StyledText</span><span class="signature">(value: str = &#39;&#39;)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a StyledText, gets markup tags.</span>

<span class="sd">        Args:</span>
<span class="sd">            markup_language: The markup language instance this object uses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">markup</span><span class="o">.</span><span class="n">tokenize_ansi</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">plain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">plain</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span>

        <span class="k">return</span> <span class="n">obj</span>
</pre></div>

        </details>

            <div class="docstring"><p>Creates a StyledText, gets markup tags.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>markup_language:</strong>  The markup language instance this object uses.</li>
</ul>
</div>


                            </div>
                            <div id="StyledText.value" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#StyledText.value">#&nbsp;&nbsp</a>

        <span class="name">value</span><span class="annotation">: str</span>
    </div>

    
            <div class="docstring"><p>The underlying, ANSI-inclusive string value.</p>
</div>


                            </div>
                            <div id="StyledText.plain" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#StyledText.plain">#&nbsp;&nbsp</a>

        <span class="name">plain</span><span class="annotation">: str</span>
    </div>

    
            <div class="docstring"><p>The string value with no ANSI sequences.</p>
</div>


                            </div>
                            <div id="StyledText.tokens" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#StyledText.tokens">#&nbsp;&nbsp</a>

        <span class="name">tokens</span><span class="annotation">: list[pytermgui.parser.Token]</span>
    </div>

    
            <div class="docstring"><p>The list of tokens that make up this string.</p>
</div>


                            </div>
                            <div id="StyledText.plain_index" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#StyledText.plain_index">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plain_index</span><span class="signature">(self, index: int | None) -&gt; int | None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plain_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Finds given index inside plain text.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">styled_chars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">plain_chars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">negative_index</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">negative_index</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TokenType</span><span class="o">.</span><span class="n">PLAIN</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">styled_chars</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">plain_chars</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">negative_index</span><span class="p">:</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">plain_chars</span> <span class="o">+</span> <span class="n">styled_chars</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">styled_chars</span> <span class="o">+</span> <span class="n">plain_chars</span>

                <span class="n">plain_chars</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="kc">None</span>
</pre></div>

        </details>

            <div class="docstring"><p>Finds given index inside plain text.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.str</dt>
                                <dd id="StyledText.encode" class="function">encode</dd>
                <dd id="StyledText.replace" class="function">replace</dd>
                <dd id="StyledText.split" class="function">split</dd>
                <dd id="StyledText.rsplit" class="function">rsplit</dd>
                <dd id="StyledText.join" class="function">join</dd>
                <dd id="StyledText.capitalize" class="function">capitalize</dd>
                <dd id="StyledText.casefold" class="function">casefold</dd>
                <dd id="StyledText.title" class="function">title</dd>
                <dd id="StyledText.center" class="function">center</dd>
                <dd id="StyledText.count" class="function">count</dd>
                <dd id="StyledText.expandtabs" class="function">expandtabs</dd>
                <dd id="StyledText.find" class="function">find</dd>
                <dd id="StyledText.partition" class="function">partition</dd>
                <dd id="StyledText.index" class="function">index</dd>
                <dd id="StyledText.ljust" class="function">ljust</dd>
                <dd id="StyledText.lower" class="function">lower</dd>
                <dd id="StyledText.lstrip" class="function">lstrip</dd>
                <dd id="StyledText.rfind" class="function">rfind</dd>
                <dd id="StyledText.rindex" class="function">rindex</dd>
                <dd id="StyledText.rjust" class="function">rjust</dd>
                <dd id="StyledText.rstrip" class="function">rstrip</dd>
                <dd id="StyledText.rpartition" class="function">rpartition</dd>
                <dd id="StyledText.splitlines" class="function">splitlines</dd>
                <dd id="StyledText.strip" class="function">strip</dd>
                <dd id="StyledText.swapcase" class="function">swapcase</dd>
                <dd id="StyledText.translate" class="function">translate</dd>
                <dd id="StyledText.upper" class="function">upper</dd>
                <dd id="StyledText.startswith" class="function">startswith</dd>
                <dd id="StyledText.endswith" class="function">endswith</dd>
                <dd id="StyledText.removeprefix" class="function">removeprefix</dd>
                <dd id="StyledText.removesuffix" class="function">removesuffix</dd>
                <dd id="StyledText.isascii" class="function">isascii</dd>
                <dd id="StyledText.islower" class="function">islower</dd>
                <dd id="StyledText.isupper" class="function">isupper</dd>
                <dd id="StyledText.istitle" class="function">istitle</dd>
                <dd id="StyledText.isspace" class="function">isspace</dd>
                <dd id="StyledText.isdecimal" class="function">isdecimal</dd>
                <dd id="StyledText.isdigit" class="function">isdigit</dd>
                <dd id="StyledText.isnumeric" class="function">isnumeric</dd>
                <dd id="StyledText.isalpha" class="function">isalpha</dd>
                <dd id="StyledText.isalnum" class="function">isalnum</dd>
                <dd id="StyledText.isidentifier" class="function">isidentifier</dd>
                <dd id="StyledText.isprintable" class="function">isprintable</dd>
                <dd id="StyledText.zfill" class="function">zfill</dd>
                <dd id="StyledText.format" class="function">format</dd>
                <dd id="StyledText.format_map" class="function">format_map</dd>
                <dd id="StyledText.maketrans" class="function">maketrans</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="markup">
                                <div class="attr variable"><a class="headerlink" href="#markup">#&nbsp;&nbsp</a>

        <span class="name">markup</span><span class="default_value"> = &lt;<a href="#MarkupLanguage">pytermgui.parser.MarkupLanguage</a> object&gt;</span>
    </div>

    
    

                </section>
                <section id="tim">
                                <div class="attr variable"><a class="headerlink" href="#tim">#&nbsp;&nbsp</a>

        <span class="name">tim</span><span class="default_value"> = &lt;<a href="#MarkupLanguage">pytermgui.parser.MarkupLanguage</a> object&gt;</span>
    </div>

    
    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>